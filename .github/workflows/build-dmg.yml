name: Build macOS DMG

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-dmg:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build output
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> src-tauri/target

      - name: Install dependencies
        run: npm ci

      - name: Validate release signing secrets
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          APPLE_API_ISSUER: ${{ secrets.APPLE_API_ISSUER }}
          APPLE_API_KEY: ${{ secrets.APPLE_API_KEY }}
          APPLE_API_PRIVATE_KEY: ${{ secrets.APPLE_API_PRIVATE_KEY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail

          if [[ -z "${APPLE_CERTIFICATE:-}" || -z "${APPLE_CERTIFICATE_PASSWORD:-}" || -z "${KEYCHAIN_PASSWORD:-}" ]]; then
            echo "::error::Missing required signing secrets: APPLE_CERTIFICATE, APPLE_CERTIFICATE_PASSWORD, KEYCHAIN_PASSWORD"
            exit 1
          fi

          if [[ -n "${APPLE_API_ISSUER:-}" && -n "${APPLE_API_KEY:-}" && -n "${APPLE_API_PRIVATE_KEY:-}" ]]; then
            echo "NOTARIZATION_METHOD=api_key" >> "$GITHUB_ENV"
          elif [[ -n "${APPLE_ID:-}" && -n "${APPLE_PASSWORD:-}" && -n "${APPLE_TEAM_ID:-}" ]]; then
            echo "NOTARIZATION_METHOD=apple_id" >> "$GITHUB_ENV"
          else
            echo "::error::Missing notarization secrets. Use either APPLE_API_ISSUER+APPLE_API_KEY+APPLE_API_PRIVATE_KEY or APPLE_ID+APPLE_PASSWORD+APPLE_TEAM_ID."
            exit 1
          fi

      - name: Import Apple signing certificate
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          set -euo pipefail

          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          CERT_PATH="$RUNNER_TEMP/certificate.p12"
          printf '%s' "$APPLE_CERTIFICATE" | base64 --decode > "$CERT_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -t 3600 -u "$KEYCHAIN_PATH"

          security import "$CERT_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          SIGNING_IDENTITY="$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | grep 'Developer ID Application' | head -n 1 | sed -E 's/.*\"([^\"]+)\".*/\1/')"
          if [[ -z "$SIGNING_IDENTITY" ]]; then
            echo "::error::No Developer ID Application identity found in certificate."
            security find-identity -v -p codesigning "$KEYCHAIN_PATH"
            exit 1
          fi

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          echo "APPLE_SIGNING_IDENTITY=$SIGNING_IDENTITY" >> "$GITHUB_ENV"

      - name: Prepare App Store Connect API key
        if: ${{ startsWith(github.ref, 'refs/tags/v') && secrets.APPLE_API_ISSUER != '' && secrets.APPLE_API_KEY != '' && secrets.APPLE_API_PRIVATE_KEY != '' }}
        env:
          APPLE_API_KEY: ${{ secrets.APPLE_API_KEY }}
          APPLE_API_PRIVATE_KEY: ${{ secrets.APPLE_API_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          KEY_PATH="$RUNNER_TEMP/AuthKey_${APPLE_API_KEY}.p8"
          printf '%s' "$APPLE_API_PRIVATE_KEY" > "$KEY_PATH"
          chmod 600 "$KEY_PATH"
          echo "APPLE_API_KEY_PATH=$KEY_PATH" >> "$GITHUB_ENV"

      - name: Build DMG (signed release)
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        env:
          APPLE_SIGNING_IDENTITY: ${{ env.APPLE_SIGNING_IDENTITY }}
          APPLE_API_ISSUER: ${{ secrets.APPLE_API_ISSUER }}
          APPLE_API_KEY: ${{ secrets.APPLE_API_KEY }}
          APPLE_API_KEY_PATH: ${{ env.APPLE_API_KEY_PATH }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: npm run tauri:build

      - name: Build DMG (unsigned)
        if: ${{ !startsWith(github.ref, 'refs/tags/v') }}
        run: npm run tauri:build

      - name: Verify signed app and notarized DMG
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        run: |
          set -euo pipefail
          APP_PATH="$(ls -d src-tauri/target/release/bundle/macos/*.app | head -n 1)"
          DMG_PATH="$(ls src-tauri/target/release/bundle/dmg/*.dmg | head -n 1)"
          codesign --verify --deep --strict --verbose=2 "$APP_PATH"
          spctl --assess --type execute -vv "$APP_PATH"
          xcrun stapler validate "$DMG_PATH"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: GrassMate-dmg
          path: src-tauri/target/release/bundle/dmg/*.dmg
          if-no-files-found: error

      - name: Create GitHub Release and upload DMG
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: src-tauri/target/release/bundle/dmg/*.dmg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup signing files
        if: ${{ always() && startsWith(github.ref, 'refs/tags/v') }}
        run: |
          security delete-keychain "${KEYCHAIN_PATH:-$RUNNER_TEMP/build.keychain-db}" || true
          rm -f "$RUNNER_TEMP/certificate.p12" "$RUNNER_TEMP"/AuthKey_*.p8
